#!/bin/bash

# Íµ¨ÌòÑÏ≤¥ ÎπåÎìú
make

# Í∏∞Ï°¥ result ÎîîÎ†âÌÜ†Î¶¨ Ï¥àÍ∏∞Ìôî
echo "üìÅ Ï¥àÍ∏∞Ìôî: result/ ÎîîÎ†âÌÜ†Î¶¨Î•º ÎπÑÏõÅÎãàÎã§."
rm -rf result
mkdir -p result/cfgs

for file in tests/*.s; do
    name=$(basename "$file" .s)
    log_file="result/${name}.log"
    input_file="tests/${name}.in"

    echo "‚ñ∂ Running on $file"
    
    # Ïã§Ìñâ (2Ï¥à Ï†úÌïú), ÏûÖÎ†• ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ Î¶¨Îã§Ïù¥Î†âÏÖò
    if [ -f "$input_file" ]; then
        echo "  - üì• using input from $input_file"
            timeout 2s bash -c "cat '$input_file' '$input_file' '$input_file' '$input_file'   \
               | dune exec -- ./main.exe '$file'" > "$log_file" 2>&1
    else
        timeout 2s dune exec -- ./main.exe "$file" \
            > "$log_file" 2>&1
    fi
    exit_code=$?

    if [ $exit_code -eq 124 ]; then
        echo "‚è∞ Timeout occurred"   >> "$log_file"
        echo "‚ö†Ô∏è  $name timed ÏïÑÏõÉ after 2 seconds."
    else
        echo "‚úÖ Finished $name within time."
    fi

    # cfg.dot Ï≤òÎ¶¨
    if [ -f cfg.dot ]; then
        cp cfg.dot "result/cfgs/cfg_${name}.dot"
        dot -Tpng cfg.dot -o "result/cfgs/cfg_${name}.png"
        echo "  - CFG image saved as result/cfgs/cfg_${name}.png"
    else
        echo "  - ‚ö†Ô∏è cfg.dot not found, skipping dot conversion"
    fi
done
